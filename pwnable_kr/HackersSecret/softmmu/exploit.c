#include <stdio.h>
#include <unistd.h>
#include <errno.h>
#include <sys/types.h>
#include <fcntl.h>
#include <stdlib.h>
#include <string.h>

typedef unsigned int u32;
typedef unsigned long long u64;

const char* softmmu_dev = "/proc/softmmu"; 
int fd = -1;


int write_dev(void* buf, int len)
{
    int w = write(fd, buf, len);
    if(w != len) {
        printf("Failed to write %d (%d) bytes from buf: %p to fd: %d\n", len, w, buf, fd);
    }
    return w;
}

int read_dev(void* buf, int len)
{
    int r = read(fd, buf, len);
    if(r != len) {
        printf("Failed to read %d (%d) bytes from buf: %p to fd: %d\n", len, r, buf, fd);
    }
    return r;
}

u64 virt_to_phys(u32 va)
{
    char buf[8];
    memset(buf, 0 , sizeof(buf));
    write_dev((void*)&va, 4);
    read_dev(buf, 8);
    return *(u64*)buf;
}

void print_v_p(const char* sym, u32 virt, u64 phys)
{
    printf("Symbol [%s] virt: 0x%4x - phys: 0x%8llx\n", sym, virt, phys);
}


int main(int argc, char** argv)
{
    //u32 vaddr = *(u32*)argv[1];
    
    fd = open(softmmu_dev, O_RDWR);
    if(fd == -1) {
        printf("Failed to open %s, errno: %d, exiting.\n", softmmu_dev, errno);
        exit(1);
    }

    u64 main_phys = virt_to_phys((u32)&main);

    print_v_p("main", (u32)&main, main_phys);

    return 0;

}
